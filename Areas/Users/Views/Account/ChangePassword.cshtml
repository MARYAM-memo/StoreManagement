@model ChangePasswordVM

@{
    ViewData["Title"] = "Change Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-key fa-2x me-3"></i>
                        <div>
                            <h4 class="mb-0">Change Password</h4>
                            <small>Update your account password</small>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Password Requirements Info -->
                    <div class="alert alert-info mb-4">
                        <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Password Requirements</h5>
                        <ul class="mb-0">
                            <li>Minimum 6 characters in length</li>
                            <li>At least one uppercase letter (A-Z)</li>
                            <li>At least one lowercase letter (a-z)</li>
                            <li>At least one digit (0-9)</li>
                            <li>Special characters are optional</li>
                        </ul>
                    </div>

                    <!-- Validation Summary -->
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h5>
                            <ul class="mb-0">
                                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                {
                                    <li>@error.ErrorMessage</li>
                                }
                            </ul>
                        </div>
                    }

                    <form asp-action="ChangePassword" method="post">
                        <input type="hidden" asp-for="UserId" />

                        <!-- Current Password -->
                        <div class="mb-4">
                            <label asp-for="CurrentPassword" class="form-label fw-bold">
                                <i class="fas fa-lock me-2"></i>Current Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                <input asp-for="CurrentPassword" type="password" class="form-control"
                                    placeholder="Enter your current password" id="currentPassword" />
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="togglePassword('currentPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                        </div>

                        <!-- New Password -->
                        <div class="mb-4">
                            <label asp-for="NewPassword" class="form-label fw-bold">
                                <i class="fas fa-lock me-2"></i>New Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="NewPassword" type="password" class="form-control"
                                    placeholder="Enter new password" id="newPassword"
                                    onkeyup="checkPasswordStrength(this.value)" />
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="togglePassword('newPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="NewPassword" class="text-danger"></span>

                            <!-- Password Strength Meter -->
                            <div class="mt-2">
                                <div class="progress" style="height: 8px;">
                                    <div id="passwordStrengthBar" class="progress-bar" role="progressbar"
                                        style="width: 0%;"></div>
                                </div>
                                <small id="passwordStrengthText" class="form-text text-muted"></small>
                            </div>
                        </div>

                        <!-- Confirm New Password -->
                        <div class="mb-4">
                            <label asp-for="ConfirmPassword" class="form-label fw-bold">
                                <i class="fas fa-lock me-2"></i>Confirm New Password
                            </label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                <input asp-for="ConfirmPassword" type="password" class="form-control"
                                    placeholder="Confirm new password" id="confirmPassword" />
                                <button type="button" class="btn btn-outline-secondary"
                                    onclick="togglePassword('confirmPassword', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>

                            <!-- Password Match Indicator -->
                            <div class="mt-2">
                                <small id="passwordMatchText" class="form-text"></small>
                            </div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Update Password
                            </button>
                            <a asp-action="Index" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>

                <div class="card-footer bg-light">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Your password is encrypted and securely stored
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                Last updated: @DateTime.Now.ToString("MMMM dd, yyyy")
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Tips -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Password Security Tips</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li><small>Use a unique password for each account</small></li>
                                <li><small>Avoid using personal information</small></li>
                                <li><small>Don't reuse old passwords</small></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li><small>Consider using a password manager</small></li>
                                <li><small>Change passwords regularly</small></li>
                                <li><small>Enable two-factor authentication if available</small></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
                button.title = 'Hide password';
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
                button.title = 'Show password';
            }
        }

        // Check password strength
        function checkPasswordStrength(password) {
            let strength = 0;
            let text = '';
            let color = '';

            // Length check
            if (password.length >= 8) strength += 25;

            // Contains numbers
            if (/\d/.test(password)) strength += 25;

            // Contains lowercase
            if (/[a-z]/.test(password)) strength += 25;

            // Contains uppercase
            if (/[A-Z]/.test(password)) strength += 25;

            // Update progress bar
            const bar = document.getElementById('passwordStrengthBar');
            bar.style.width = strength + '%';

            // Update text and color
            if (strength <= 25) {
                text = 'Very Weak';
                color = 'bg-danger';
            } else if (strength <= 50) {
                text = 'Weak';
                color = 'bg-warning';
            } else if (strength <= 75) {
                text = 'Good';
                color = 'bg-info';
            } else {
                text = 'Strong';
                color = 'bg-success';
            }

            // Update UI
            bar.className = 'progress-bar ' + color;
            document.getElementById('passwordStrengthText').textContent =
                'Strength: ' + text + ' (' + strength + '%)';

            // Check password match
            const confirmPassword = document.getElementById('confirmPassword').value;
            checkPasswordMatch(password, confirmPassword);
        }

        // Check if passwords match
        function checkPasswordMatch(password, confirmPassword) {
            const matchText = document.getElementById('passwordMatchText');

            if (!password || !confirmPassword) {
                matchText.textContent = '';
                matchText.className = 'form-text';
                return;
            }

            if (password === confirmPassword) {
                matchText.textContent = '✓ Passwords match';
                matchText.className = 'form-text text-success';
            } else {
                matchText.textContent = '✗ Passwords do not match';
                matchText.className = 'form-text text-danger';
            }
        }

        // Real-time password match checking
        document.getElementById('confirmPassword').addEventListener('keyup', function () {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            checkPasswordMatch(password, confirmPassword);
        });

        // Prevent form submission if passwords don't match
        document.querySelector('form').addEventListener('submit', function (e) {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                e.preventDefault();
                alert('Passwords do not match. Please confirm your new password.');
                document.getElementById('confirmPassword').focus();
            }
        });

        // Auto-focus on current password field
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('currentPassword').focus();
        });

        // Show password requirements on focus
        document.getElementById('newPassword').addEventListener('focus', function () {
            const requirements = document.querySelector('.alert-info');
            requirements.style.display = 'block';
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Ctrl+Enter to submit
            if (e.ctrlKey && e.key === 'Enter') {
                document.querySelector('form').submit();
            }

            // Escape to cancel
            if (e.key === 'Escape') {
                window.location.href = '@Url.Action("Index", "Users", new { area = "Users" })';
            }
        });
    </script>
}
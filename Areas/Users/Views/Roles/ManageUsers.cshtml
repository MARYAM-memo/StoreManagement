@model UserRoleVM

@{
    ViewData["Title"] = "Manage Role Users";
}

<div class="card">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-people me-2"></i>Manage Users for Role: @ViewBag.RoleName</h4>
    </div>

    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-person-check me-2"></i>Users in this Role</h5>
                    </div>
                    <div class="card-body">
                        <div id="usersInRoleList">
                            @if (ViewBag.UsersInRole != null && ((List<ApplicationUser>)ViewBag.UsersInRole).Count > 0)
                            {
                                <ul class="list-group">
                                    @foreach (var user in (List<ApplicationUser>)ViewBag.UsersInRole)
                                    {
                                        <li class="list-group-item d-flex justify-content-between align-items-center"
                                            id="user-@user.Id">
                                            <div>
                                                <strong>@user.FullName</strong>
                                                <div class="small text-muted">@user.UserName</div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-danger remove-user-btn"
                                                data-user-id="@user.Id" data-role-id="@ViewBag.RoleId">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <p class="text-muted text-center">No users assigned to this role</p>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Add Users to Role</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                        </div>

                        <div id="availableUsersList" style="max-height: 300px; overflow-y: auto;">
                            @if (ViewBag.AllUsers != null)
                            {
                                foreach (var user in (List<ApplicationUser>)ViewBag.AllUsers)
                                {
                                    // Check if user is already in role
                                    var usersInRole = ViewBag.UsersInRole as List<ApplicationUser>;
                                    var isInRole = usersInRole?.Any(u => u.Id == user.Id) ?? false;

                                    if (!isInRole)
                                    {
                                        <div class="card mb-2 user-card" data-user-id="@user.Id" data-user-name="@user.FullName"
                                            data-user-username="@user.UserName">
                                            <div class="card-body p-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@user.FullName</strong>
                                                        <div class="small text-muted">@user.UserName</div>
                                                    </div>
                                                    <button type="button" class="btn btn-sm btn-success add-user-btn"
                                                        data-user-id="@user.Id" data-role-id="@ViewBag.RoleId">
                                                        <i class="bi bi-plus-circle"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4">
            <a asp-action="Details" asp-route-id="@ViewBag.RoleId" class="btn btn-info">
                <i class="bi bi-arrow-left me-1"></i>Back to Role Details
            </a>
            <a asp-action="Index" class="btn btn-secondary">Back to Roles List</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Search users
            $('#userSearch').on('keyup', function () {
                var value = $(this).val().toLowerCase();
                $('.user-card').filter(function () {
                    $(this).toggle(
                        $(this).text().toLowerCase().indexOf(value) > -1
                    );
                });
            });

            // Add user to role
            $('.add-user-btn').on('click', function () {
                var userId = $(this).data('user-id');
                var roleId = $(this).data('role-id');
                var userName = $(this).closest('.user-card').data('user-name');
                var userUsername = $(this).closest('.user-card').data('user-username');

                $.ajax({
                    url: '@Url.Action("AddUserToRole", "Roles")',
                    type: 'POST',
                    data: {
                        roleId: roleId,
                        userId: userId
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            // Remove from available list
                            $('.user-card[data-user-id="' + userId + '"]').remove();

                            // Add to role list
                            var newItem = `
                                    <li class="list-group-item d-flex justify-content-between align-items-center" id="user-${userId}">
                                        <div>
                                            <strong>${userName}</strong>
                                            <div class="small text-muted">${userUsername}</div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-danger remove-user-btn" 
                                                data-user-id="${userId}" data-role-id="${roleId}">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </li>
                                `;
                            $('#usersInRoleList ul').append(newItem);

                            // Show success message
                            toastr.success(response.message);
                        } else {
                            toastr.error(response.message);
                        }
                    }
                });
            });

            // Remove user from role
            $(document).on('click', '.remove-user-btn', function () {
                var userId = $(this).data('user-id');
                var roleId = $(this).data('role-id');
                var userCard = $(this).closest('li');
                var userName = userCard.find('strong').text();
                var userUsername = userCard.find('.text-muted').text();

                $.ajax({
                    url: '@Url.Action("RemoveUserFromRole", "Roles")',
                    type: 'POST',
                    data: {
                        roleId: roleId,
                        userId: userId
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (response) {
                        if (response.success) {
                            // Remove from role list
                            userCard.remove();

                            // Add back to available list
                            var newCard = `
                                    <div class="card mb-2 user-card" data-user-id="${userId}" 
                                         data-user-name="${userName}" data-user-username="${userUsername}">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${userName}</strong>
                                                    <div class="small text-muted">${userUsername}</div>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-success add-user-btn" 
                                                        data-user-id="${userId}" data-role-id="${roleId}">
                                                    <i class="bi bi-plus-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            $('#availableUsersList').append(newCard);

                            // Show success message
                            toastr.success(response.message);
                        } else {
                            toastr.error(response.message);
                        }
                    }
                });
            });
        });
    </script>
}
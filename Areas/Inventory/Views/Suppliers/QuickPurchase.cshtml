@using StoreManagement.Areas.Inventory.ViewModels
@model StockTransactionVM

@{
    ViewData["Title"] = "Quick Purchase";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-shopping-cart text-primary me-2"></i>Quick Purchase</h2>
            <p class="text-muted mb-0">Make a quick purchase from @Model.SupplierName</p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Suppliers
        </a>
    </div>

    <!-- Supplier Info Card -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="fas fa-truck me-2"></i>Supplier Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-2">
                        <strong>Supplier:</strong> @Model.SupplierName
                    </div>
                    
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="text-muted">
                        <small>Transaction Date: @Model.TransactionDate.ToString("yyyy-MM-dd HH:mm")</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Form -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-cart-plus me-2"></i>Purchase Details</h5>
        </div>
        <div class="card-body">
            <form asp-action="ProcessQuickPurchase" method="post" id="purchaseForm">
                <input type="hidden" asp-for="SupplierId" />
                <input type="hidden" asp-for="TransactionType" value="Purchase" />
                
                <!-- Basic Information -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="ReferenceNumber" class="form-label">Reference/Invoice #</label>
                            <input asp-for="ReferenceNumber" class="form-control" 
                                   placeholder="Enter invoice number or reference" />
                            <span asp-validation-for="ReferenceNumber" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="TransactionDate" class="form-label">Purchase Date</label>
                            <input asp-for="TransactionDate" type="datetime-local" class="form-control" />
                            <span asp-validation-for="TransactionDate" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Products Selection -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-boxes me-2"></i>Select Products</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addProductRow()">
                            <i class="fas fa-plus me-1"></i>Add Product
                        </button>
                    </div>

                    <!-- Products Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="productsTable">
                            <thead class="table-light">
                                <tr>
                                    <th width="40%">Product</th>
                                    <th width="15%">Quantity</th>
                                    <th width="15%">Total</th>
                                    <th width="15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productRows">
                                <!-- Product rows will be added here dynamically -->
                            </tbody>
                            <tfoot>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end fw-bold">Grand Total:</td>
                                    <td>
                                        <span class="fw-bold fs-5" id="grandTotal">0.00</span>
                                        <input type="hidden" id="totalAmount" name="TotalAmount" value="0" />
                                    </td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label asp-for="Notes" class="form-label">Notes</label>
                    <textarea asp-for="Notes" class="form-control" rows="3" 
                              placeholder="Add any notes about this purchase..."></textarea>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                        <i class="fas fa-broom me-2"></i>Clear Form
                    </button>
                    <div>
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-check-circle me-2"></i>Complete Purchase
                        </button>
                        <button type="button" class="btn btn-primary btn-lg" onclick="saveDraft()">
                            <i class="fas fa-save me-2"></i>Save Draft
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title"><i class="fas fa-search me-2"></i>Select Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="productSearch" 
                           placeholder="Search products by name or SKU...">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Select</th>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Price</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            @foreach (var product in Model.Products)
                            {
                                <tr>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary select-product" 
                                                data-id="@product.Id" 
                                                data-name="@product.Name"
                                                data-price="@product.Price">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td>@product.Name</td>
                                    <td>@product.StockQuantity</td>
                                    <td>@product.Price.ToString("C2")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    
    <script>
        // Product data from server
        let products = @Html.Raw(Json.Serialize(Model.Products.Select(p => new {
            Id = p.Id,
            Name = p.Name,
            Price = p.Price,
            Stock = p.StockQuantity
        })));

        let productCounter = 0;
        let selectedProducts = [];

        $(document).ready(function() {
            // Initialize date picker
            $('#TransactionDate').val(new Date().toISOString().slice(0, 16));
            
            // Add first empty row
            addProductRow();
            
            // Initialize product search
            $('#productSearch').on('keyup', function() {
                const value = $(this).val().toLowerCase();
                $('#productList tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
                });
            });
        });

        // Add new product row
        function addProductRow(productId = null) {
            const rowId = `product_${productCounter++}`;
            const rowHtml = `
                <tr id="${rowId}">
                    <td>
                        <div class="input-group">
                            <input type="hidden" name="TransactionItems[${productCounter}].ProductId" class="product-id" />
                            <input type="text" class="form-control product-name" readonly 
                                   placeholder="Click to select product" 
                                   onclick="showProductModal(${rowId})" />
                            <button type="button" class="btn btn-outline-primary" onclick="showProductModal(${rowId})">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <input type="number" class="form-control quantity" min="1" value="1" 
                               onchange="calculateRowTotal(${rowId})" 
                               onkeyup="calculateRowTotal(${rowId})">
                    </td>

                    <td>
                        <span class="row-total">0.00</span>
                        <input type="hidden" class="row-total-input" 
                               name="TransactionItems[${productCounter}].TotalPrice" value="0" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeProductRow(${rowId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            $('#productRows').append(rowHtml);
            
            // If productId is provided, select it
            if (productId) {
                selectProductForRow(rowId, productId);
            }
            
            updateGrandTotal();
        }

        // Show product selection modal
        function showProductModal(rowId) {
            currentRow = rowId;
            $('#productModal').modal('show');
        }

        // Select product for a row
        function selectProductForRow(rowId, productId) {
            const product = products.find(p => p.Id == productId);
            if (!product) return;
            
            const row = $(`#${rowId}`);
            row.find('.product-id').val(product.Id);
            row.find('.product-name').val(`${product.Name}`);
            
            
            calculateRowTotal(rowId);
            
            // Mark product as selected
            selectedProducts.push(product.Id);
            updateProductModal();
        }

        // Product selection from modal
        $(document).on('click', '.select-product', function() {
            const productId = $(this).data('id');
            const productName = $(this).data('name');
            const productPrice = $(this).data('price');
            
            if (selectedProducts.includes(productId)) {
                alert('This product is already selected. Please choose another product.');
                return;
            }
            
            // Find the current row (last added empty row)
            const currentRow = $('#productRows tr').last();
            const rowId = currentRow.attr('id');
            
            currentRow.find('.product-id').val(productId);
            currentRow.find('.product-name').val(`${productName}`);
            
            
            calculateRowTotal(rowId);
            
            // Mark product as selected
            selectedProducts.push(productId);
            
            // Close modal and add new empty row
            $('#productModal').modal('hide');
            addProductRow();
            
            updateProductModal();
        });

        // Update product modal to disable selected products
        function updateProductModal() {
            $('.select-product').each(function() {
                const productId = $(this).data('id');
                if (selectedProducts.includes(productId)) {
                    $(this).prop('disabled', true).addClass('btn-secondary').removeClass('btn-outline-primary');
                } else {
                    $(this).prop('disabled', false).addClass('btn-outline-primary').removeClass('btn-secondary');
                }
            });
        }

        // Calculate row total
        function calculateRowTotal(rowId) {
            const row = $(`#${rowId}`);
            const quantity = parseFloat(row.find('.quantity').val()) || 0;
            const unitCost = parseFloat(row.find('.unit-cost').val()) || 0;
            const total = quantity * unitCost;
            
            row.find('.row-total').text(total.toFixed(2));
            row.find('.row-total-input').val(total.toFixed(2));
            
            updateGrandTotal();
        }

        // Update grand total
        function updateGrandTotal() {
            let grandTotal = 0;
            $('.row-total-input').each(function() {
                grandTotal += parseFloat($(this).val()) || 0;
            });
            
            $('#grandTotal').text(grandTotal.toFixed(2));
            $('#totalAmount').val(grandTotal.toFixed(2));
        }

        // Remove product row
        function removeProductRow(rowId) {
            const row = $(`#${rowId}`);
            const productId = row.find('.product-id').val();
            
            if (productId) {
                // Remove from selected products
                const index = selectedProducts.indexOf(parseInt(productId));
                if (index > -1) {
                    selectedProducts.splice(index, 1);
                    updateProductModal();
                }
            }
            
            row.remove();
            updateGrandTotal();
            
            // If no rows left, add an empty one
            if ($('#productRows tr').length === 0) {
                addProductRow();
            }
        }

        // Clear form
        function clearForm() {
            if (confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
                $('#productRows').empty();
                selectedProducts = [];
                productCounter = 0;
                addProductRow();
                $('#ReferenceNumber').val('');
                $('#Notes').val('');
                $('#TransactionDate').val(new Date().toISOString().slice(0, 16));
                updateProductModal();
            }
        }

        // Save draft
        function saveDraft() {
            // Implement draft saving logic here
            // For now, just alert
            alert('Draft saving functionality will be implemented soon.');
        }

        // Form validation before submission
        $('#purchaseForm').on('submit', function(e) {
            let isValid = true;
            let errorMessage = '';
            
            // Check if at least one product is selected
            if ($('.product-id').filter(function() { return $(this).val(); }).length === 0) {
                isValid = false;
                errorMessage = 'Please select at least one product.';
            }
            
            // Check if all selected products have valid quantities and prices
            $('.quantity').each(function() {
                const quantity = parseFloat($(this).val());
                if (!quantity || quantity <= 0) {
                    isValid = false;
                    errorMessage = 'Please enter valid quantity for all products.';
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert(errorMessage);
                return false;
            }
            
            return true;
        });
    </script>
}
@using StoreManagement.Models

@{
    ViewData["Title"] = "Bulk Purchase";
    var products = ViewBag.Products as List<Product>;
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-cart-plus"></i> Bulk Purchase
        </h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <!-- Bulk Purchase Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Bulk Purchase Information</h6>
                </div>
                <div class="card-body">
                    <!-- Supplier Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-bold">Supplier</label>
                                <select class="form-select" id="supplierSelect" required>
                                    <option value="">-- Select Supplier --</option>
                                    @foreach (var supplier in ViewBag.Suppliers)
                                    {
                                        <option value="@supplier.Value">@supplier.Text</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label fw-bold">Reference Number</label>
                                <input type="text" class="form-control" id="referenceNumber"
                                    value="BULK-@DateTime.Now.ToString("yyyyMMddHHmm")" />
                            </div>
                        </div>
                    </div>

                    <!-- Products Table -->
                    <div class="card border mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">Purchase Items</h6>
                            <button type="button" class="btn btn-sm btn-success" onclick="addPurchaseItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="purchaseItemsContainer">
                                <!-- سيتم إضافة العناصر هنا -->
                            </div>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">Summary</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Total Items:</td>
                                            <td class="text-end" id="totalItems">0</td>
                                        </tr>
                                        <tr>
                                            <td>Total Quantity:</td>
                                            <td class="text-end" id="totalQuantity">0</td>
                                        </tr>
                                        <tr class="table-active">
                                            <th>Total Cost:</th>
                                            <th class="text-end text-success" id="totalCost">$0.00</th>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label class="form-label fw-bold">Notes</label>
                                <textarea class="form-control" id="bulkNotes" rows="3"
                                    placeholder="Any notes about this bulk purchase..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-group mt-4 pt-3 border-top">
                        <button type="button" class="btn btn-primary" onclick="submitBulkPurchase()">
                            <i class="fas fa-save"></i> Process Bulk Purchase
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Available Products -->
        <div class="col-lg-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-box"></i> Available Products
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products..." />
                    </div>
                    <div id="productsList" style="max-height: 400px; overflow-y: auto;">
                        @if (products != null)
                        {
                            foreach (var product in products)
                            {
                                <div class="product-item mb-2 p-2 border rounded" data-product-id="@product.Id"
                                    data-product-name="@product.Name" data-product-price="@product.Price"
                                    data-product-cost="@product.Price" data-product-stock="@product.StockQuantity"
                                    style="cursor: pointer;">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>@product.Name</strong>
                                            <br />

                                        </div>
                                        <div class="text-end">
                                            <div class="text-success">@product.Price.ToString("C")</div>
                                            <small class="text-muted">Stock: @product.StockQuantity</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let itemCounter = 0;
        const products = @Html.Raw(Json.Serialize(products));

        $(document).ready(function () {
            // Initialize with one empty item
            addPurchaseItem();

            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Product search
            $('#productSearch').on('input', function () {
                const searchTerm = $(this).val().toLowerCase();
                $('#productsList .product-item').each(function () {
                    const productName = $(this).data('product-name').toLowerCase();
                    const productSKU = $(this).data('product-sku')?.toLowerCase() || '';
                    if (productName.includes(searchTerm) || productSKU.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
        }

        function addPurchaseItem(productId = null, productName = '', cost = 0, stock = 0, sku = '') {
            itemCounter++;
            const itemId = `item_${itemCounter}`;

            let productSelectHtml = '';
            if (productId) {
                // If product is pre-selected
                productSelectHtml = `
                            <input type="hidden" class="product-id" value="${productId}" />
                            <div class="fw-bold">${productName}</div>
                            <small class="text-muted">SKU: ${sku} | Stock: ${stock}</small>
                        `;
            } else {
                // Create product dropdown
                productSelectHtml = `
                            <select class="form-select product-select">
                                <option value="">-- Select Product --</option>
                                ${products.map(p =>
                    `<option value="${p.id}" 
                                            data-cost="${p.costPrice || 0}" 
                                            data-stock="${p.quantityInStock}"
                                            data-sku="${p.sku}">
                                        ${p.name} (${p.sku}) - Stock: ${p.quantityInStock}
                                    </option>`
                ).join('')}
                            </select>
                        `;
            }

            const itemHtml = `
                        <div class="purchase-item border rounded p-3 mb-3" id="${itemId}">
                            <div class="row">
                                <div class="col-md-5">
                                    <label class="form-label fw-bold">Product</label>
                                    ${productSelectHtml}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Quantity</label>
                                    <input type="number" class="form-control quantity-input" value="1" min="1" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Unit Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control cost-input" value="${cost}" step="0.01" min="0.01" />
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Actions</label>
                                    <button type="button" class="btn btn-danger btn-sm w-100" 
                                            onclick="removePurchaseItem('${itemId}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <label class="form-label">Notes</label>
                                    <input type="text" class="form-control notes-input" placeholder="Item notes..." />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Total Cost</label>
                                    <div class="h6 text-success item-total">$0.00</div>
                                </div>
                            </div>
                        </div>
                    `;

            $('#purchaseItemsContainer').append(itemHtml);

            // Setup event listeners for the new item
            const itemElement = $(`#${itemId}`);

            if (productId) {
                itemElement.find('.cost-input').val(cost);
                updateItemTotal(itemElement);
            } else {
                itemElement.find('.product-select').change(function () {
                    const selectedOption = $(this).find('option:selected');
                    const cost = selectedOption.data('cost') || 0;
                    itemElement.find('.cost-input').val(cost);
                    updateItemTotal(itemElement);
                });
            }

            itemElement.find('.quantity-input, .cost-input').on('input', function () {
                updateItemTotal(itemElement);
            });
        }

        function removePurchaseItem(itemId) {
            $(`#${itemId}`).remove();
            updateSummary();
        }

        function updateItemTotal(itemElement) {
            const quantity = parseFloat(itemElement.find('.quantity-input').val()) || 0;
            const cost = parseFloat(itemElement.find('.cost-input').val()) || 0;
            const total = quantity * cost;

            itemElement.find('.item-total').text('$' + total.toFixed(2));
            updateSummary();
        }

        function updateSummary() {
            let totalItems = 0;
            let totalQuantity = 0;
            let totalCost = 0;

            $('.purchase-item').each(function () {
                totalItems++;
                const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                const cost = parseFloat($(this).find('.cost-input').val()) || 0;
                totalQuantity += quantity;
                totalCost += quantity * cost;
            });

            $('#totalItems').text(totalItems);
            $('#totalQuantity').text(totalQuantity);
            $('#totalCost').text('$' + totalCost.toFixed(2));
        }

        // Product click handler
        $(document).on('click', '.product-item', function () {
            const productId = $(this).data('product-id');
            const productName = $(this).data('product-name');
            const cost = $(this).data('product-cost');
            const stock = $(this).data('product-stock');
            const sku = $(this).data('product-sku');

            addPurchaseItem(productId, productName, cost, stock, sku);
        });

        function submitBulkPurchase() {
            const supplierId = $('#supplierSelect').val();
            const referenceNumber = $('#referenceNumber').val();
            const notes = $('#bulkNotes').val();

            if (!supplierId) {
                alert('Please select a supplier');
                return;
            }

            const items = [];
            $('.purchase-item').each(function () {
                const productId = $(this).find('.product-id').val() ||
                    $(this).find('.product-select').val();

                if (productId) {
                    const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                    const unitCost = parseFloat($(this).find('.cost-input').val()) || 0;
                    const itemNotes = $(this).find('.notes-input').val();

                    items.push({
                        productId: parseInt(productId),
                        quantity: quantity,
                        unitCost: unitCost,
                        notes: itemNotes
                    });
                }
            });

            if (items.length === 0) {
                alert('Please add at least one product');
                return;
            }

            if (confirm(`Process bulk purchase with ${items.length} items?\nTotal Cost: $${$('#totalCost').text().replace('$', '')}`)) {
                $.ajax({
                    url: '@Url.Action("BulkPurchase", "StockTransactions")',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        supplierId: parseInt(supplierId),
                        items: items
                    }),
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            window.location.href = '@Url.Action("Index", "StockTransactions")';
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('An error occurred. Please try again.');
                    }
                });
            }
        }

        function resetForm() {
            $('#purchaseItemsContainer').empty();
            $('#supplierSelect').val('');
            $('#referenceNumber').val('BULK-@DateTime.Now.ToString("yyyyMMddHHmm")');
            $('#bulkNotes').val('');
            itemCounter = 0;
            addPurchaseItem();
            updateSummary();
        }
    </script>
}
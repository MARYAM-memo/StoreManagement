@using StoreManagement.Areas.Sales.ViewModels
@* في Areas/Sales/Views/Orders/Create.cshtml *@
@model OrderVM

@{
    ViewData["Title"] = "Create New Order";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-plus-circle"></i> Create New Order
        </h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to List
        </a>
    </div>

    <!-- Order Form -->
    <div class="row">
        <!-- Left Column: Order Details -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Order Information</h6>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post" id="orderForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <input type="hidden" id="orderTotal" name="TotalAmount" value="0" />

                        <!-- Customer Selection -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="CustomerId" class="form-label fw-bold"></label>
                                    <select asp-for="CustomerId" class="form-select"
                                        asp-items="@(new SelectList(Model.Customers, "Id", "Name"))" required>
                                        <option value="">-- Select Customer --</option>
                                    </select>
                                    <span asp-validation-for="CustomerId" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="OrderDate" class="form-label fw-bold"></label>
                                    <input asp-for="OrderDate" class="form-control" type="datetime-local" />
                                    <span asp-validation-for="OrderDate" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Status and Payment -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="Status" class="form-label fw-bold"></label>
                                    <select asp-for="Status" class="form-select">
                                        <option value="Pending">Pending</option>
                                        <option value="Processing">Processing</option>
                                        <option value="Completed">Completed</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="Refunded">Refunded</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="PaymentMethod" class="form-label fw-bold"></label>
                                    <select asp-for="PaymentMethod" class="form-select">
                                        <option value="">-- Select Payment --</option>
                                        <option value="Cash">Cash</option>
                                        <option value="Credit Card">Credit Card</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                        <option value="PayPal">PayPal</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <span asp-validation-for="PaymentMethod" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label asp-for="PaymentStatus" class="form-label fw-bold"></label>
                                    <select asp-for="PaymentStatus" class="form-select">
                                        <option value="Pending">Pending</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Failed">Failed</option>
                                        <option value="Refunded">Refunded</option>
                                    </select>
                                    <span asp-validation-for="PaymentStatus" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Order Items Section -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 fw-bold">
                                    <i class="fas fa-boxes"></i> Order Items
                                    <button type="button" class="btn btn-sm btn-success float-end"
                                        onclick="addOrderItem()">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="orderItemsContainer">
                                    <!-- سيتم إضافة العناصر هنا بالـ JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Addresses -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="ShippingAddress" class="form-label fw-bold"></label>
                                    <textarea asp-for="ShippingAddress" class="form-control" rows="3"></textarea>
                                    <span asp-validation-for="ShippingAddress" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="BillingAddress" class="form-label fw-bold"></label>
                                    <textarea asp-for="BillingAddress" class="form-control" rows="3"></textarea>
                                    <span asp-validation-for="BillingAddress" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Costs and Notes -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="ShippingCost" class="form-label fw-bold"></label>
                                    <input asp-for="ShippingCost" class="form-control" value="0" />
                                    <span asp-validation-for="ShippingCost" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="TaxAmount" class="form-label fw-bold"></label>
                                    <input asp-for="TaxAmount" class="form-control" value="0" />
                                    <span asp-validation-for="TaxAmount" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="DiscountAmount" class="form-label fw-bold"></label>
                                    <input asp-for="DiscountAmount" class="form-control" value="0" />
                                    <span asp-validation-for="DiscountAmount" class="text-danger small"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label fw-bold">Final Total</label>
                                    <div class="h4 text-success" id="finalTotal">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="form-group mb-4">
                            <label asp-for="Notes" class="form-label fw-bold"></label>
                            <textarea asp-for="Notes" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Notes" class="text-danger small"></span>
                        </div>

                        <!-- Form Buttons -->
                        <div class="form-group mt-4 pt-3 border-top">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Create Order
                            </button>
                            <button type="reset" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Summary and Products -->
        <div class="col-lg-4">
            <!-- Order Summary -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-info text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-calculator"></i> Order Summary
                    </h6>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Subtotal:</td>
                            <td class="text-end" id="subtotalAmount">$0.00</td>
                        </tr>
                        <tr>
                            <td>Shipping:</td>
                            <td class="text-end" id="shippingAmount">$0.00</td>
                        </tr>
                        <tr>
                            <td>Tax:</td>
                            <td class="text-end" id="taxAmount">$0.00</td>
                        </tr>
                        <tr>
                            <td>Discount:</td>
                            <td class="text-end text-danger" id="discountAmount">$0.00</td>
                        </tr>
                        <tr class="table-active">
                            <th>Total:</th>
                            <th class="text-end text-success" id="summaryTotal">$0.00</th>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Quick Products -->
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-box"></i> Available Products
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products..." />
                    </div>
                    <div id="productsList" style="max-height: 300px; overflow-y: auto;">
                        @foreach (var product in Model.Products)
                        {
                            <div class="product-item mb-2 p-2 border rounded" data-product-id="@product.Id"
                                data-product-name="@product.Name" data-product-price="@product.Price"
                                data-product-stock="@product.StockQuantity" style="cursor: pointer;">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>@product.Name</strong>
                                        
                                    </div>
                                    <div class="text-end">
                                        <div class="text-success">@product.Price.ToString("C")</div>
                                        <small class="text-muted">Stock: @product.StockQuantity</small>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let orderItems = [];
        let itemCounter = 0;
        const products = @Html.Raw(Json.Serialize(Model.Products));

        $(document).ready(function () {
            // Initialize with one empty item
            addOrderItem();

            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Update totals when costs change
            $('#ShippingCost, #TaxAmount, #DiscountAmount').on('input', updateTotals);

            // Product search
            $('#productSearch').on('input', function () {
                const searchTerm = $(this).val().toLowerCase();
                $('#productsList .product-item').each(function () {
                    const productName = $(this).data('product-name').toLowerCase();
                    
                    if (productName.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
        }

        function addOrderItem(productId = null, productName = '', price = 0, stock = 0) {
            itemCounter++;
            const itemId = `item_${itemCounter}`;

            let productSelectHtml = '';
            if (productId) {
                // If product is pre-selected
                productSelectHtml = `
                        <input type="hidden" name="OrderItems[${itemCounter - 1}].ProductId" value="${productId}" />
                        <div class="fw-bold">${productName}</div>
                        <small class="text-muted">Stock: ${stock}</small>
                    `;
            } else {
                // Create product dropdown
                productSelectHtml = `
                        <select class="form-select product-select" 
                                name="OrderItems[${itemCounter - 1}].ProductId" required>
                            <option value="">-- Select Product --</option>
                            ${products.map(p =>
                    `<option value="${p.id}" data-price="${p.price}" data-stock="${p.quantityInStock}">
                                    ${p.name}- ${p.price.toFixed(2)} USD
                                </option>`
                ).join('')}
                        </select>
                    `;
            }

            const itemHtml = `
                    <div class="order-item border rounded p-3 mb-3" id="${itemId}">
                        <div class="row">
                            <div class="col-md-5">
                                <label class="form-label fw-bold">Product</label>
                                ${productSelectHtml}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Quantity</label>
                                <input type="number" class="form-control quantity-input" 
                                       name="OrderItems[${itemCounter - 1}].Quantity" 
                                       value="1" min="1" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Unit Price</label>
                                <input type="number" class="form-control price-input" 
                                       name="OrderItems[${itemCounter - 1}].UnitPrice" 
                                       value="${price}" step="0.01" min="0.01" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Actions</label>
                                <button type="button" class="btn btn-danger btn-sm w-100" 
                                        onclick="removeOrderItem('${itemId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${!productId ? `
                        <div class="row mt-2">
                            <div class="col-md-3">
                                <label class="form-label">Discount %</label>
                                <input type="number" class="form-control discount-input" 
                                       name="OrderItems[${itemCounter - 1}].Discount" 
                                       value="0" min="0" max="100" step="0.01" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Total</label>
                                <div class="h6 text-success item-total">$0.00</div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;

            $('#orderItemsContainer').append(itemHtml);

            // Setup event listeners for the new item
            $(`#${itemId} .product-select`).change(function () {
                const selectedOption = $(this).find('option:selected');
                const price = selectedOption.data('price') || 0;
                const stock = selectedOption.data('stock') || 0;

                $(this).closest('.order-item').find('.price-input').val(price);
                updateItemTotal($(this).closest('.order-item'));
            });

            $(`#${itemId} .quantity-input, #${itemId} .price-input, #${itemId} .discount-input`).on('input', function () {
                updateItemTotal($(this).closest('.order-item'));
            });

            if (productId) {
                updateItemTotal($(`#${itemId}`));
            }
        }

        function removeOrderItem(itemId) {
            $(`#${itemId}`).remove();
            updateTotals();
        }

        function updateItemTotal(itemElement) {
            const quantity = parseFloat(itemElement.find('.quantity-input').val()) || 0;
            const price = parseFloat(itemElement.find('.price-input').val()) || 0;
            const discount = parseFloat(itemElement.find('.discount-input').val()) || 0;

            const discountMultiplier = 1 - (discount / 100);
            const itemTotal = quantity * price * discountMultiplier;

            itemElement.find('.item-total').text('$' + itemTotal.toFixed(2));
            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;

            // Calculate subtotal from all items
            $('.order-item').each(function () {
                const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                const price = parseFloat($(this).find('.price-input').val()) || 0;
                const discount = parseFloat($(this).find('.discount-input').val()) || 0;
                const discountMultiplier = 1 - (discount / 100);
                subtotal += quantity * price * discountMultiplier;
            });

            const shipping = parseFloat($('#ShippingCost').val()) || 0;
            const tax = parseFloat($('#TaxAmount').val()) || 0;
            const discount = parseFloat($('#DiscountAmount').val()) || 0;

            const total = subtotal + shipping + tax - discount;

            // Update display
            $('#subtotalAmount').text('$' + subtotal.toFixed(2));
            $('#shippingAmount').text('$' + shipping.toFixed(2));
            $('#taxAmount').text('$' + tax.toFixed(2));
            $('#discountAmount').text('$' + discount.toFixed(2));
            $('#summaryTotal').text('$' + total.toFixed(2));
            $('#finalTotal').text('$' + total.toFixed(2));

            // Update hidden field for form submission
            $('#orderTotal').val(total.toFixed(2));
        }

        // Product click handler
        $(document).on('click', '.product-item', function () {
            const productId = $(this).data('product-id');
            const productName = $(this).data('product-name');
            const price = $(this).data('product-price');
            const stock = $(this).data('product-stock');

            addOrderItem(productId, productName, price, stock);
        });
    </script>
}